<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cutter Admin</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .admin-wrap { max-width: 760px; margin: 2rem auto; background: #0f1223; color: #e5e7eb; padding: 1rem 1.25rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);} 
    .row { display: grid; grid-template-columns: 160px 1fr; gap: 10px; align-items: center; margin: 8px 0; }
    input { padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.25); color: #f8fafc; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.18); background: linear-gradient(135deg,#10b98155,#22d3ee33); color: #e5f7ff; font-weight: 600; }
    .note { font-size: .9rem; color: #cbd5e1; margin-top: 8px; }
    .result { white-space: pre-wrap; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; padding: 8px; margin-top: 10px; }
  </style>
</head>
<body class="chat-body">
  <div class="admin-wrap">
    <h2>Admin – Health & Upsert User</h2>
    <div class="row"><label>API Base</label><input id="apiBase" value="" placeholder="auto (leave blank for default)" /></div>
    <div class="row"><label>Admin Token</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="token" type="password" placeholder="Paste ADMIN_TOKEN" />
        <button id="toggleToken" type="button" title="Show/Hide">Show</button>
      </div>
    </div>

    <h3>Health</h3>
    <div class="row"><label>Service</label><div id="svcHealth">–</div></div>
    <div class="row"><label>Redis</label><div id="redisHealth">–</div></div>
    <div class="row"><label>Redis Scheme</label><div id="redisScheme">–</div></div>
    <div class="row"><label>Realtime</label><div id="rtHealth">–</div></div>
    <div class="row"><label></label><button id="healthBtn">Refresh Health</button></div>

    <hr/>
    <h3>Upsert User</h3>
    <div class="row"><label>Name</label><input id="name" placeholder="Full name e.g., Cris R" /></div>
    <div class="row"><label>Display Name</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="display" placeholder="e.g., Cris R" />
        <button id="lookupBtn" type="button" title="Lookup">Lookup</button>
      </div>
    </div>
    <div class="row"><label>ID Code</label><input id="idcode" placeholder="ALPHA1234 (optional)" /></div>
    <div class="row"><label>Number</label><input id="number" placeholder="+441234567890 (optional)" /></div>
    <div class="row"><label>Passphrase</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="pass" placeholder="it's a priest thing (optional)" />
        <button id="verifyBtn" type="button" title="Verify with user">Verify</button>
        <button id="debugBtn" type="button" title="Debug normalization">Debug</button>
      </div>
    </div>
    <div class="row"><label></label><button id="saveBtn">Create / Update</button></div>
    <div class="note">This writes to Redis: user hash + reverse mappings (name_to_user, idcode_to_user, number_to_user). Requires ADMIN_TOKEN set on the backend.</div>
    <div id="result" class="result"></div>

    <hr/>
    <h3>Literature Indexing</h3>
    <div class="row"><label>Content Dir</label><input id="litDir" placeholder="default: content/na" /></div>
    <div class="row"><label></label><button id="reindexBtn">Reindex PDFs</button></div>
    <div class="row"><label>Search</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="litQuery" placeholder="e.g., powerlessness step one"/>
        <button id="litSearchBtn">Search</button>
      </div>
    </div>
    <div id="litOut" class="result"></div>
  </div>

  <script type="module">
    const autoBase = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://cutter.onrender.com';
    const apiBaseEl = document.getElementById('apiBase');
    apiBaseEl.value = sessionStorage.getItem('admin_api_base') || '';
    const tokenEl = document.getElementById('token');
    tokenEl.value = sessionStorage.getItem('admin_token') || '';

    const $ = (id) => document.getElementById(id);
    const out = $("result");
    const svc = $("svcHealth");
    const red = $("redisHealth");
    const rt = $("rtHealth");
    const scheme = $("redisScheme");

    async function upsert() {
      const base = (apiBaseEl.value || autoBase).replace(/\/$/, '');
      let token = tokenEl.value.trim().replace(/^['"]|['"]$/g, '');
      sessionStorage.setItem('admin_api_base', apiBaseEl.value);
      sessionStorage.setItem('admin_token', token);
      const body = {
        name: $("name").value.trim(),
        display_name: $("display").value.trim() || null,
        id_code: $("idcode").value.trim() || null,
        number: $("number").value.trim() || null,
        passphrase: $("pass").value,
      };
      try {
        const res = await fetch(base + '/v2/admin/user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        out.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        out.textContent = 'Error: ' + (e?.message || e);
      }
    }

    document.getElementById('saveBtn').addEventListener('click', upsert);
    document.getElementById('healthBtn').addEventListener('click', refreshHealth);
    document.getElementById('verifyBtn').addEventListener('click', verifyPass);
    document.getElementById('debugBtn').addEventListener('click', debugPass);
    document.getElementById('lookupBtn').addEventListener('click', lookupUser);
    document.getElementById('reindexBtn').addEventListener('click', reindexLit);
    document.getElementById('litSearchBtn').addEventListener('click', searchLit);

    async function refreshHealth() {
      const base = (apiBaseEl.value || autoBase).replace(/\/$/, '');
      const token = tokenEl.value.trim();
      try {
        const r1 = await fetch(base + '/v2/health');
        const h1 = await r1.json();
        svc.textContent = h1.service + ' (' + (h1.model || 'n/a') + ')';
        red.textContent = h1.redis_ok ? 'OK' : 'FAIL';
        scheme.textContent = h1.redis_scheme || 'unknown';
        rt.textContent = h1.openai_realtime_ok ? 'OK' : 'Limited/Off';
      } catch (e) {
        svc.textContent = 'Error';
      }
      try {
        let token = tokenEl.value.trim().replace(/^['"]|['"]$/g, '');
        const r2 = await fetch(base + '/v2/admin/health', { headers: { 'Authorization': 'Bearer ' + token }});
        const h2 = await r2.json();
        // If admin health fails auth, show brief message in result panel
        if (!r2.ok) out.textContent = JSON.stringify(h2, null, 2);
      } catch (e) {
        // ignore
      }
    }

    // Auto refresh on load
    refreshHealth();

    // Toggle token visibility
    document.getElementById('toggleToken').addEventListener('click', () => {
      tokenEl.type = tokenEl.type === 'password' ? 'text' : 'password';
      document.getElementById('toggleToken').textContent = tokenEl.type === 'password' ? 'Show' : 'Hide';
    });

    async function verifyPass() {
      const base = (apiBaseEl.value || autoBase).replace(/\/$/, '');
      let token = tokenEl.value.trim().replace(/^['"]|['"]$/g, '');
      const display = $("display").value.trim() || $("name").value.trim();
      const pass = $("pass").value;
      if (!display || !pass) {
        out.textContent = 'Please fill Display Name (or Name) and Passphrase first.';
        return;
      }
      try {
        const res = await fetch(base + '/v2/admin/verify-pass', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ display_name: display, passphrase: pass })
        });
        const data = await res.json();
        out.textContent = 'Verify result: ' + JSON.stringify(data, null, 2);
      } catch (e) {
        out.textContent = 'Error verifying: ' + (e?.message || e);
      }
    }

    async function lookupUser() {
      const base = (apiBaseEl.value || autoBase).replace(/\/$/, '');
      let token = tokenEl.value.trim().replace(/^['"]|['"]$/g, '');
      const display = $("display").value.trim() || $("name").value.trim();
      if (!display) { out.textContent = 'Please enter a Display Name first.'; return; }
      try {
        const url = base + '/v2/admin/user-by-display?display_name=' + encodeURIComponent(display);
        const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token }});
        const data = await res.json();
        out.textContent = 'Lookup: ' + JSON.stringify(data, null, 2);
        if (data?.found && data?.name) $("name").value = data.name;
      } catch (e) {
        out.textContent = 'Error looking up user: ' + (e?.message || e);
      }
    }

    async function debugPass() {
      const base = (apiBaseEl.value || autoBase).replace(/\/$/, '');
      let token = tokenEl.value.trim().replace(/^['"]|['"]$/g, '');
      const display = $("display").value.trim() || $("name").value.trim();
      const pass = $("pass").value;
      if (!display || !pass) { out.textContent = 'Please fill Display Name (or Name) and Passphrase first.'; return; }
      try {
        const res = await fetch(base + '/v2/admin/debug-pass', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ display_name: display, passphrase: pass })
        });
        const data = await res.json();
        out.textContent = 'Debug: ' + JSON.stringify(data, null, 2);
      } catch (e) {
        out.textContent = 'Error debugging: ' + (e?.message || e);
      }
    }

    async function reindexLit() {
      const base = (apiBaseEl.value || autoBase).replace(/\/$/, '');
      let token = tokenEl.value.trim().replace(/^['"]|['"]$/g, '');
      try {
        const res = await fetch(base + '/v2/admin/lit/reindex?overwrite=true', {
          method: 'POST', headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        document.getElementById('litOut').textContent = 'Reindex: ' + JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById('litOut').textContent = 'Error: ' + (e?.message || e);
      }
    }

    async function searchLit() {
      const base = (apiBaseEl.value || autoBase).replace(/\/$/, '');
      const q = document.getElementById('litQuery').value.trim();
      if (!q) return;
      try {
        const res = await fetch(base + '/v2/lit/search?q=' + encodeURIComponent(q) + '&k=4');
        const data = await res.json();
        document.getElementById('litOut').textContent = 'Search: ' + JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById('litOut').textContent = 'Error: ' + (e?.message || e);
      }
    }
  </script>
</body>
</html>
